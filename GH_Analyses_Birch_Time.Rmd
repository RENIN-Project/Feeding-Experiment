---
title: "FE_Publication_GH_Time"
output:
  html_document:
    df_print: paged
---

```{r}
library(ROBITaxonomy)
library(ROBITools)
library(vegan)
library(ade4)
library(ggplot2)
library(tidyverse)
library(permute)
library(lattice)

# The palette with grey:
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# The palette with black:
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

```

--------------------------------------------------------------------------

# The Read contingency table
```{r}
reads = read.csv("Data/Faeces/FE.Spermatophyta.samples.reads.csv",
                 header = TRUE,
                 row.names = 1)
reads = as.matrix(reads)
```

# The sample description table
```{r}
samples = read.csv("Data/Faeces/FE.Spermatophyta.samples.samples.csv",
                 header = TRUE,
                 row.names = 1)
```

# The MOTU description table
```{r}
motus = read.csv("Data/Faeces/FE.Spermatophyta.samples.motus.csv",
                 header = TRUE,
                 row.names = 1)
```

# Create an object, where you merge the three tables
```{r}
Sper01 = metabarcoding.data(reads = reads,
                          samples = samples,
                          motus = motus)
```

--------------------------------------------------------------------------

```{r}
motus.hist = colMeans(reads(Sper01))
Sper01@motus$mean_ref_freq = motus.hist
Sper01 = Sper01[,order(motus.hist,decreasing = TRUE)]
```

```{r}
motus(Sper01)[1:20,c("scientific_name","mean_ref_freq", "rank")]
```

```{r}
table(motus(Sper01)$rank)
```

# Loading of metadata

```{r}
samples.metadata = read_csv("Data/Faeces/sampling_dates.csv")
```

```{r}
samples.metadata = inner_join(samples.metadata,Sper01@samples,by="sample_id")
```

```{r}
rownames(samples.metadata) = as.character(samples.metadata$sample_id)
samples.metadata = samples.metadata[rownames(Sper01),]
```

```{r}
Sper01@samples = as.data.frame(samples.metadata)
rownames(Sper01@samples) = rownames(as.character(Sper01@samples$sample_id))
```


```{r}
Sper01@samples[Sper01@samples$animal_id=="X","times_from_birch"] = 
  Sper01@samples[Sper01@samples$animal_id=="X","times_from_birch"] + 6

Sper01@samples[Sper01@samples$animal_id=="Y","times_from_birch"] = 
  Sper01@samples[Sper01@samples$animal_id=="Y","times_from_birch"] + 3

Sper01@samples[Sper01@samples$animal_id=="Z","times_from_birch"] = 
  Sper01@samples[Sper01@samples$animal_id=="Z","times_from_birch"] + 4
```
View(Sper01@samples)

--------------------------------------------------------------------------

```{r}
Sper01$hellinger = decostand(reads(Sper01), method = "hellinger")
Sper01$relfreq   = decostand(reads(Sper01), method = "total")
Sper01$presence  = reads(Sper01) >0
```


```{r}
Animal_id = rep("Unknown", nrow(samples(Sper01)))
Animal_id[which(samples(Sper01)$animal_id == "X")] = "9/10"
Animal_id[which(samples(Sper01)$animal_id == "Y")] = "10/10"
Animal_id[which(samples(Sper01)$animal_id == "Z")] = "12/10"
Sper01@samples$Animal_id=factor(Animal_id, levels=c("9/10","10/10","12/10"))
```

```{r}
Animal = Sper01@samples$Animal_id
```

--------------------------------------------------------------------------

Sper01@reads
samples(Sper01)[1:210,c("Animal_id","replicate", "Sample_number")]

```{r}
list(Sper01@samples)
```


```{r}
taxo = read.taxonomy("Data/ncbi20210212")
```

```{r}
Betula.taxid = ecofind(taxo,"^Fagales$")
is.a.Betula = is.subcladeof(taxonomy = taxo,Sper01@motus$taxid,Betula.taxid)
is.a.Betula[is.na(is.a.Betula)]=FALSE
sum(is.a.Betula,na.rm = TRUE)

Sper01@motus[is.a.Betula,c("scientific_name","mean_ref_freq")]

Betula = Sper01@reads[,is.a.Betula]
```



```{r}
plot2 = ggplot(data = as.data.frame(Sper01@reads), 
                     aes(x = samples(Sper01)$times_from_birch/24,
                         y = GHP1_00000007 + GHP1_00000030 + GHP1_00000681 + GHP3_00000153 + GHP1_00003018)) +
  geom_point(aes(shape = Animal, color = Animal)) +
  scale_colour_grey(guide = "legend") +
  scale_x_continuous(breaks = 5) +  
  xlim(-2,30) + 
  scale_y_log10() +
  geom_vline (xintercept = 26, colour = "black") +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  labs(y="Proportion of Betulaceae DNA", 
       x="Time (days after Betula pubescens was fed)") +
  labs(y=expression('Proportion of'~italic(Betulaceae)~ 'DNA'),
       x=expression('Time (days after'~italic(Betula)~ ~italic( pubescens)~ 'was fed)'),
       fill="Var1")
plot2
```

```{r}
ggsave("GH.Time_for_publication.png", plot = plot2, width = 25, height = 16, units = c("cm"))
```


panel.grid.major = element_blank(), 


```{r}
plot3 = ggplot(data = as.data.frame(Sper01@reads), 
                     aes(x = samples(Sper01)$times_from_birch/24,
                         y = GHP1_00000007 + GHP1_00000030 + GHP1_00000681 + GHP3_00000153 + GHP1_00003018,
                         color = Animal)) +
  geom_point(aes(shape = Animal, color = Animal)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30)) +  
  xlim(-2,30) + 
  scale_y_log10() +
  geom_vline (xintercept = 26, colour = "black") +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  labs(y="Proportion of Betulaceae DNA", 
       x="Time (days after Betula pubescens was fed)") +
  labs(y=expression('Proportion of'~italic(Betulaceae)~ 'DNA'),
       x=expression('Time (days after'~italic(Betula)~ ~italic( pubescens)~ 'was fed)'),
       fill="Var1")
plot3
```

```{r}
ggsave("GH.Time_for_publication_colors.png", plot = plot3, width = 25, height = 16, units = c("cm"))
```


```{r}
plot4 = ggplot(data = as.data.frame(Sper01@reads), 
                     aes(x = samples(Sper01)$times_from_birch/24,
                         y = GHP1_00000007 + GHP1_00000030 + GHP1_00000681 + GHP3_00000153 + GHP1_00003018,
                         color = Animal)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30)) +  
  xlim(-2,30) + 
  geom_vline (xintercept = 26, colour = "black") +
  geom_smooth(method = "loess", se = FALSE) +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  labs(y="Proportion of Betulaceae DNA", 
       x="Time (days after Betula pubescens was fed)") +
  labs(y=expression('Proportion of'~italic(Betulaceae)~ 'DNA'),
       x=expression('Time (days after'~italic(Betula)~ ~italic( pubescens)~ 'was fed)'),
       fill="Var1")
plot4
```


```{r}
plot5 = ggplot(data = as.data.frame(Sper01@reads), 
                     aes(x = samples(Sper01)$times_from_birch/24,
                         y = GHP1_00000007 + GHP1_00000030 + GHP1_00000681 + GHP3_00000153 + GHP1_00003018,
                         color = Animal)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30)) +  
  xlim(-2,30) + 
  geom_vline (xintercept = 26, colour = "black") +
  geom_smooth(method = "loess", se = TRUE) +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  labs(y="Proportion of Betulaceae DNA", 
       x="Time (days after Betula pubescens was fed)") +
  labs(y=expression('Proportion of'~italic(Betulaceae)~ 'DNA'),
       x=expression('Time (days after'~italic(Betula)~ ~italic( pubescens)~ 'was fed)'),
       fill="Var1")
plot5
```

```{r}
plot6 = ggplot(data = as.data.frame(Sper01@reads), 
                     aes(x = samples(Sper01)$times_from_birch/24,
                         y = GHP1_00000007 + GHP1_00000030 + GHP1_00000681 + GHP3_00000153 + GHP1_00003018,
                         color = Animal)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30)) +  
  stat_summary_bin(fun.y = mean, geom = "line") +
  xlim(-2,30) + 
  geom_vline (xintercept = 26, colour = "black") +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  labs(y="Proportion of Betulaceae DNA", 
       x="Time (days after Betula pubescens was fed)") +
  labs(y=expression('Proportion of'~italic(Betulaceae)~ 'DNA'),
       x=expression('Time (days after'~italic(Betula)~ ~italic( pubescens)~ 'was fed)'),
       fill="Var1")
plot6
```





  geom_line(aes(color = Animal), size = 0.5, stat = "mean") +




```{r}
plot3 = ggplot(data = as.data.frame(Sper01@reads), 
                     aes(x = samples(Sper01)$times_from_birch/24,
                         y = GHP1_00000007 + GHP1_00000030 + GHP1_00000681 + GHP3_00000153 + GHP1_00003018)) +
  geom_point(aes(shape = Animal), size = 2) +
  scale_x_continuous(breaks = c(0, 10, 20, 30)) +  
  scale_shape_manual(values=c(4, 2, 1))+
  xlim(-2,30) + 
  geom_vline (xintercept = 26, colour = "black") +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  labs(y="Proportion of Betulaceae DNA", 
       x="Time (days after Betula pubescens was fed)") +
  labs(y=expression('Proportion of'~italic(Betulaceae)~ 'DNA'),
       x=expression('Time (days after'~italic(Betula)~ ~italic( pubescens)~ 'was fed)'),
       fill="Var1")
plot3
```

```{r}
ggsave("GH.Time_for_publication_black.png", plot = plot3, width = 25, height = 16, units = c("cm"))
```






```{r}
plot3 = ggplot(data = as.data.frame(Sper01@reads), 
                     aes(x = samples(Sper01)$times_from_birch/24,
                         y = GHP1_00000007 + GHP1_00000030 + GHP1_00000681 + GHP3_00000153 + GHP1_00003018,
                         color = Animal)) +
  geom_point(aes(color = Animal)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30)) +  
  stat_summary_bin(fun.y = mean, geom = "line") +
  xlim(-2,30) + 
  geom_vline (xintercept = 26, colour = "black") +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  labs(y="Proportion of Betulaceae DNA", 
       x="Time (days after Betula pubescens was fed)") +
  labs(y=expression('Proportion of'~italic(Betulaceae)~ 'DNA'),
       x=expression('Time (days after'~italic(Betula)~ ~italic( pubescens)~ 'was fed)'),
       fill="Var1")
plot3
```


```{r}
ggsave("GH.Time_for_publication_colors.png", plot = plot3, width = 25, height = 16, units = c("cm"))
```




```{r}
plot8 = ggplot(data = as.data.frame(Sper01@reads), 
                     aes(x = samples(Sper01)$times_from_birch/24,
                         y = GHP1_00000007 + GHP1_00000030 + GHP1_00000681 + GHP3_00000153 + GHP1_00003018)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30)) +  
  stat_summary_bin(fun.y = mean, geom = "line") +
  xlim(-2,30) + 
  geom_vline (xintercept = 26, colour = "black") +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  labs(y="Proportion of Betulaceae DNA", 
       x="Time (days after Betula pubescens was fed)") +
  labs(y=expression('Proportion of'~italic(Betulaceae)~ 'DNA'),
       x=expression('Time (days after'~italic(Betula)~ ~italic( pubescens)~ 'was fed)'),
       fill="Var1")
plot8
```


```{r}
ggsave("GH.Time_for_publication_oneline.png", plot = plot8, width = 25, height = 16, units = c("cm"))
```


```{r}
plot9 = ggplot(data = as.data.frame(Sper01@reads), 
                     aes(x = samples(Sper01)$times_from_birch/24,
                         y = GHP1_00000007 + GHP1_00000030 + GHP1_00000681 + GHP3_00000153 + GHP1_00003018)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30)) +  
  geom_point(aes(color = Animal)) +
  stat_summary_bin(fun.y = mean, geom = "line") +
  xlim(-2,30) + 
  geom_vline (xintercept = 26, colour = "black", linetype = "dotted") +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  labs(y="Proportion of birch DNA", 
       x="Time (days after B. pubescens was fed)") +
  labs(x=expression('Time (days after'~italic(B.)~ ~italic( pubescens)~ 'was fed)'),
       fill="Var1")
plot9
```


```{r}
ggsave("GH.Time_for_publication_onelineanddots.png", plot = plot9, width = 25, height = 16, units = c("cm"))
```

```{r, fig.height=12}
Sper01@reads %>% 
  as_tibble() %>% 
  mutate(sample_id = rownames(Sper01)) %>%
  pivot_longer(cols = - "sample_id", names_to = "motu_id",values_to = "relfreq") %>%
  left_join(Sper01@motus, by = c(motu_id = "id")) %>%
  group_by(sample_id,family_name) %>%
  summarise(relfreq = sum(relfreq)) %>%
  ungroup() %>%
  left_join(Sper01@samples, by = "sample_id")  %>%
  ggplot(aes(x=times_from_birch/24,y=relfreq,col=family_name)) +
  geom_point(  ) +
  xlim(-2,30) + 
  facet_wrap(. ~ family_name, ncol=2,scales="free_y") +
  geom_vline (xintercept = 0.54, colour = "lightgrey") +
  geom_vline (xintercept = 1.54, colour = "lightgrey") +
  geom_vline (xintercept = 2.54, colour = "lightgrey") +
  geom_vline (xintercept = 5.54, colour = "lightgrey") + 
  geom_vline (xintercept = 6.54, colour = "lightgrey") + 
  geom_vline (xintercept = 7.54, colour = "lightgrey") + 
  geom_vline (xintercept = 10.54, colour = "lightgrey") +
  geom_vline (xintercept = 11.54, colour = "lightgrey") +
  geom_vline (xintercept = 12.54, colour = "lightgrey") +
  annotate("text", x = 1.60, y = 0.27, label = "20g") + 
  annotate("text", x = 6.60, y = 0.27, label = "500g") +
  annotate("text", x = 11.60, y = 0.27, label = "2000g") +
  geom_vline (xintercept = 25, colour = "black", linetype = "dotted") 
```


```{r fig.height=8}
Sper01@reads %>% 
  as_tibble() %>% 
  mutate(sample_id = rownames(Sper01)) %>%
  pivot_longer(cols = - "sample_id", names_to = "motu_id",values_to = "relfreq") %>%
  left_join(Sper01@motus, by = c(motu_id = "id")) %>%
  group_by(sample_id,family_name) %>%
  summarise(relfreq = sum(relfreq)) %>%
  ungroup() %>%
  left_join(Sper01@samples, by = "sample_id") %>%
  group_by(family_name) %>%
  mutate(max_relfreq = max(relfreq)) %>% 
  filter(max_relfreq > 0.2)  %>%
  ggplot(aes(x=times_from_birch/24,y=relfreq,col=family_name)) +
  geom_point(  ) +
  xlim(-2,30) + 
  facet_wrap(. ~ family_name, ncol=2,scales="free_y") +
  geom_vline (xintercept = 0.54, colour = "lightgrey") +
  geom_vline (xintercept = 1.54, colour = "lightgrey") +
  geom_vline (xintercept = 2.54, colour = "lightgrey") +
  geom_vline (xintercept = 5.54, colour = "lightgrey") + 
  geom_vline (xintercept = 6.54, colour = "lightgrey") + 
  geom_vline (xintercept = 7.54, colour = "lightgrey") + 
  geom_vline (xintercept = 10.54, colour = "lightgrey") +
  geom_vline (xintercept = 11.54, colour = "lightgrey") +
  geom_vline (xintercept = 12.54, colour = "lightgrey") +
  annotate("text", x = 1.60, y = 0.27, label = "20g") + 
  annotate("text", x = 6.60, y = 0.27, label = "500g") +
  annotate("text", x = 11.60, y = 0.27, label = "2000g") +
  geom_vline (xintercept = 25, colour = "black", linetype = "dotted") 
```

```{r fig.height=8}
Sper01@reads %>% 
  as_tibble() %>% 
  mutate(sample_id = rownames(Sper01)) %>%
  pivot_longer(cols = - "sample_id", names_to = "motu_id",values_to = "relfreq") %>%
  left_join(Sper01@motus, by = c(motu_id = "id")) %>%
  group_by(sample_id,family_name) %>%
  summarise(relfreq = sum(relfreq)) %>%
  ungroup() %>%
  left_join(Sper01@samples, by = "sample_id") %>%
  group_by(family_name) %>%
  mutate(max_relfreq = max(relfreq)) %>% 
  filter(max_relfreq > 0.15)  %>%
  ggplot(aes(x=factor(floor(times_from_birch/24)),y=relfreq,col=family_name)) +
  geom_boxplot(  ) +
  facet_wrap(. ~ family_name, ncol=2,scales="free_y") +
  geom_vline (xintercept = 0.54, colour = "lightgrey") +
  geom_vline (xintercept = 1.54, colour = "lightgrey") +
  geom_vline (xintercept = 2.54, colour = "lightgrey") +
  geom_vline (xintercept = 5.54, colour = "lightgrey") + 
  geom_vline (xintercept = 6.54, colour = "lightgrey") + 
  geom_vline (xintercept = 7.54, colour = "lightgrey") + 
  geom_vline (xintercept = 10.54, colour = "lightgrey") +
  geom_vline (xintercept = 11.54, colour = "lightgrey") +
  geom_vline (xintercept = 12.54, colour = "lightgrey") +
  annotate("text", x = 1.60, y = 0.27, label = "20g") + 
  annotate("text", x = 6.60, y = 0.27, label = "500g") +
  annotate("text", x = 11.60, y = 0.27, label = "2000g") +
  geom_vline (xintercept = 25, colour = "black", linetype = "dotted") 
````

```{r}
data_Sper01 = cbind(as.data.frame(Sper01@reads),
             time = samples(Sper01)$times_from_birch/24,
             animal_id = samples(Sper01)$animal_id) %>% 
        mutate(betula=GHP1_00000007 + GHP1_00000030 + GHP1_00000681 + GHP3_00000153 + GHP1_00003018)

start_time=1
end_time=9

plot1 = ggplot(data = data_Sper01, 
                      aes(x = time,
                          y =  betula,
                          color = animal_id)) +
 geom_point() + 
  geom_smooth(data = data_Sper01 %>% filter(time >= start_time & time <= end_time),
              method = lm,show.legend = FALSE) + 
  scale_color_manual(values=cbbPalette) +
  stat_summary_bin(fun = mean, geom = "line") +
  scale_y_log10() + 
  geom_vline (xintercept = c(0.54,1.54,2.54), colour = cbbPalette[6]) +
  geom_vline (xintercept = c(5.54,6.54,7.54), colour = cbbPalette[7]) + 
  geom_vline (xintercept = c(10.54,11.54,12.54), colour = cbbPalette[8]) +
  geom_vline (xintercept = 26, colour = "black") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 15),limits = c(-2,30)) +
  guides(color=guide_legend(title="Individual")) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  labs(y="Proportion of Betula DNA", 
       x="Time (days after Betula pubescens was fed)") +
  labs(x=expression('Time (days after'~italic(Betula)~ ~italic( pubescens)~ 'was fed)'),
       fill="Var1")

plot1
```


```{r}
data_Sper01  %>%
  filter(time >= start_time & 
         time <= end_time & 
           betula > 0 &
           animal_id=="X") %>% 
  lm(time ~ log(betula),data=.) -> lm_9_10

data_Sper01 %>% 
  filter(time >= start_time & 
         time <= end_time & 
           betula > 0 &
           animal_id=="Y") %>% 
  lm(time ~ log(betula),data=.) -> lm_10_10

data_Sper01 %>% 
  filter(time >= start_time & 
         time <= end_time & 
           betula > 0 &
           animal_id=="Z") %>% 
  lm(time ~ log(betula),data=.) -> lm_12_10

data_Sper01 %>% 
  filter(time >= start_time & 
         time <= end_time & 
           betula > 0) %>% 
  lm(time ~ log(betula) + animal_id,data=.) -> lm_all

half_life <- tibble(animal_id = c("9/10","10/10","12/10","all"),
                    betula_sper01 = -c(lm_9_10$coefficients[2],
                                      lm_10_10$coefficients[2],
                                      lm_12_10$coefficients[2],
                                      lm_all$coefficients[2]) * log(2) * 24,
                    ci_betula_sper01 = qnorm(p = c(0.975),
                                          mean = 0,
                                          sd = c(summary(lm_9_10)$coefficients[,"Std. Error"][2],
                                             summary(lm_10_10)$coefficients[,"Std. Error"][2],
                                             summary(lm_12_10)$coefficients[,"Std. Error"][2],
                                             summary(lm_all)$coefficients[,"Std. Error"][2])) 
                                           * log(2) * 24,
         ci_betula_sper01_inf = betula_sper01 - ci_betula_sper01,
         ci_betula_sper01_sup = betula_sper01 + ci_betula_sper01)

half_life
```

# Attempt to correct relative frequencies by the average relative frequency of constantes plants


```{r}
Sper01@reads %>% 
  as_tibble() %>% 
  mutate(sample_id = rownames(Sper01)) %>%
  pivot_longer(cols = - "sample_id", names_to = "motu_id",values_to = "relfreq") %>%
  left_join(Sper01@motus %>% select(- starts_with("obiclean_status") ), 
            by = c(motu_id = "id")) %>%   
  ungroup() %>%
  left_join(Sper01@samples, by = "sample_id") %>%
  mutate(times_from_birch = times_from_birch/24,
         time_group = floor(times_from_birch)) %>%
  filter(time_group < 26) %>%
  group_by(family_name) %>%
  summarise(mean_relfreq = mean(relfreq)) %>%
  arrange(desc(mean_relfreq)) -> family_means
  
  family_means
```

```{r}
Sper01@reads %>% 
  as_tibble() %>% 
  mutate(sample_id = rownames(Sper01)) %>%
  pivot_longer(cols = - "sample_id", names_to = "motu_id",values_to = "relfreq") %>%
  left_join(Sper01@motus %>% select(- starts_with("obiclean_status") ), 
            by = c(motu_id = "id")) %>%   
  ungroup() %>%
  left_join(Sper01@samples, by = "sample_id") %>%
  mutate(times_from_birch = times_from_birch/24,
         time_group = floor(times_from_birch)) %>%
  filter(time_group < 26) %>%
  group_by(family_name,animal_id) %>%
  mutate(mean_relfreq = mean(relfreq)) %>%
  arrange(desc(mean_relfreq)) %>%
  group_by(family_name,animal_id,mean_relfreq,time_group) %>%
  summarise(mean_group = mean(relfreq)) %>%
  mutate(correction = mean_relfreq/mean_group) %>%
  ungroup() -> corrections
corrections
```

```{r }
Sper01@reads %>% 
  as_tibble() %>% 
  mutate(sample_id = rownames(Sper01)) %>%
  pivot_longer(cols = - "sample_id", names_to = "motu_id",values_to = "relfreq") %>%
  left_join(Sper01@motus %>% select(- starts_with("obiclean_status") ), 
            by = c(motu_id = "id")) %>%   
  ungroup() %>%
  left_join(Sper01@samples, by = "sample_id") %>%
  mutate(times_from_birch = times_from_birch/24,
         time_group = floor(times_from_birch)) %>%
  filter(time_group < 26) %>%
  left_join(corrections %>% 
              filter(family_name == "Juncaceae") %>%
              select(animal_id, time_group,correction)) %>%
  mutate(cor_relfreq = relfreq * correction) %>% 
  filter(family_name=="Betulaceae") %>%
  group_by(sample_id,Animal_id,times_from_birch,time_group) %>%
  summarise(relfreq=sum(cor_relfreq)) -> corrrected_data_Sper01


ggplot(data = corrrected_data_Sper01, 
                      aes(x = times_from_birch,
                          y =  relfreq,
                          color = Animal_id)) +
  geom_point() + 
  geom_smooth(data = corrrected_data_Sper01 %>% filter(times_from_birch >= start_time & times_from_birch <= end_time),
              method = lm,show.legend = FALSE) + 
  scale_color_manual(values=cbbPalette) +
  stat_summary_bin(fun = mean, geom = "line") +
  scale_y_log10() + 
  geom_vline (xintercept = c(0.54,1.54,2.54), colour = cbbPalette[6]) +
  geom_vline (xintercept = c(5.54,6.54,7.54), colour = cbbPalette[7]) + 
  geom_vline (xintercept = c(10.54,11.54,12.54), colour = cbbPalette[8]) +
  geom_vline (xintercept = 26, colour = "black") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 15),limits = c(-2,30)) +
  guides(color=guide_legend(title="Individual")) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  labs(y="Proportion of Betula DNA", 
       x="Time (days after Betula pubescens was fed)") +
  labs(x=expression('Time (days after'~italic(Betula)~ ~italic( pubescens)~ 'was fed)'),
       fill="Var1")
  
```



```{r}
corrrected_data_Sper01  %>%
  filter(times_from_birch >= start_time & 
         times_from_birch <= end_time & 
           relfreq > 0 &
           Animal_id=="9/10") %>% 
  lm(times_from_birch ~ log(relfreq),data=.) -> lm_9_10

corrrected_data_Sper01 %>% 
  filter(times_from_birch >= start_time & 
         times_from_birch <= end_time & 
           relfreq > 0 &
           Animal_id=="10/10") %>% 
  lm(times_from_birch ~ log(relfreq),data=.) -> lm_10_10

corrrected_data_Sper01 %>% 
  filter(times_from_birch >= start_time & 
         times_from_birch <= end_time & 
           relfreq > 0 &
           Animal_id=="12/10") %>% 
  lm(times_from_birch ~ log(relfreq),data=.) -> lm_12_10

corrrected_data_Sper01 %>% 
  filter(times_from_birch >= start_time & 
         times_from_birch <= end_time & 
           relfreq > 0) %>% 
  lm(times_from_birch ~ log(relfreq) + Animal_id,data=.) -> lm_all

half_life <- tibble(animal_id = c("9/10","10/10","12/10","all"),
                    betula_sper01 = -c(lm_9_10$coefficients[2],
                                      lm_10_10$coefficients[2],
                                      lm_12_10$coefficients[2],
                                      lm_all$coefficients[2]) * log(2) * 24,
                    ci_betula_sper01 = qnorm(p = c(0.975),
                                          mean = 0,
                                          sd = c(summary(lm_9_10)$coefficients[,"Std. Error"][2],
                                             summary(lm_10_10)$coefficients[,"Std. Error"][2],
                                             summary(lm_12_10)$coefficients[,"Std. Error"][2],
                                             summary(lm_all)$coefficients[,"Std. Error"][2])) 
                                           * log(2) * 24,
         ci_betula_sper01_inf = betula_sper01 - ci_betula_sper01,
         ci_betula_sper01_sup = betula_sper01 + ci_betula_sper01)

half_life
```

# Attempt to correct relative frequencies by the ingested weight of pellet

```{r}
cumpellet <- function(init,data,demi) {
  reponse = numeric(length = length(data))
  current = init
  for (i in seq_along(data)) {
    reponse[i] = current/2^(24/demi) + data[i]
    current = reponse[i]
  }
  
  reponse
}

pellet <- read_delim("Data/pellet_weigth.txt",delim="\t",trim_ws = TRUE) %>%
          pivot_longer(-Date,names_to = "Animal_id",values_to = "pellet") %>%
          mutate(sortable_date = sapply(str_split(Date,"/"),
                                        FUN = function(x) paste(rev(x),collapse = "/"))) %>%
          group_by(Animal_id) %>% 
          arrange(sortable_date) %>% 
          mutate(cumul_pellet = cumpellet(2000,pellet,24)) %>%
          ungroup()

Sper01@samples %>% 
  left_join(pellet) %>%
  mutate(times_from_birch = times_from_birch / 24,
         time_group = floor(times_from_birch)) -> Sper01@samples
```

```{r}
Sper01@reads %>% 
  as_tibble() %>% 
  mutate(sample_id = rownames(Sper01)) %>%
  pivot_longer(cols = - "sample_id", names_to = "motu_id",values_to = "relfreq") %>%
  left_join(Sper01@motus %>% select(- starts_with("obiclean_status") ), 
            by = c(motu_id = "id")) %>%   
  ungroup() %>%
  left_join(Sper01@samples, by = "sample_id") %>%
  filter(time_group < 26) %>%
  group_by(family_name,animal_id,time_group,pellet,cumul_pellet) %>%
  summarise(mean_group = mean(relfreq)) %>%
  mutate(correction = pellet/mean_group) %>%
  ungroup() -> corrections
corrections
```


```{r }
Sper01@reads %>% 
  as_tibble() %>% 
  mutate(sample_id = rownames(Sper01)) %>%
  pivot_longer(cols = - "sample_id", names_to = "motu_id",values_to = "relfreq") %>%
  left_join(Sper01@motus %>% select(- starts_with("obiclean_status") ), 
            by = c(motu_id = "id")) %>%   
  ungroup() %>%
  left_join(Sper01@samples, by = "sample_id") %>%
  filter(time_group < 26) %>%
  left_join(corrections %>% 
              filter(family_name == "Brassicaceae") %>%
              select(animal_id, time_group,correction)) %>%
  mutate(cor_relfreq = relfreq * correction) %>% 
  filter(family_name=="Betulaceae") %>%
  group_by(sample_id,Animal_id,times_from_birch,time_group) %>%
  summarise(relfreq=sum(cor_relfreq)) -> corrrected_data_Sper01


ggplot(data = corrrected_data_Sper01, 
                      aes(x = times_from_birch,
                          y =  relfreq,
                          color = Animal_id)) +
  geom_point() + 
  geom_smooth(data = corrrected_data_Sper01 %>% filter(times_from_birch >= start_time & times_from_birch <= end_time),
              method = lm,show.legend = FALSE) + 
  scale_color_manual(values=cbbPalette) +
  stat_summary_bin(fun = mean, geom = "line") +
  scale_y_log10() + 
  geom_vline (xintercept = c(0.54,1.54,2.54), colour = cbbPalette[6]) +
  geom_vline (xintercept = c(5.54,6.54,7.54), colour = cbbPalette[7]) + 
  geom_vline (xintercept = c(10.54,11.54,12.54), colour = cbbPalette[8]) +
  geom_vline (xintercept = 26, colour = "black") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 15),limits = c(-2,30)) +
  guides(color=guide_legend(title="Individual")) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  labs(y="Proportion of Betula DNA", 
       x="Time (days after Betula pubescens was fed)") +
  labs(x=expression('Time (days after'~italic(Betula)~ ~italic( pubescens)~ 'was fed)'),
       fill="Var1")
  
```



```{r}
corrrected_data_Sper01  %>%
  filter(times_from_birch >= start_time & 
         times_from_birch <= end_time & 
           relfreq > 0 &
           Animal_id=="9/10") %>% 
  lm(times_from_birch ~ log(relfreq),data=.) -> lm_9_10

corrrected_data_Sper01 %>% 
  filter(times_from_birch >= start_time & 
         times_from_birch <= end_time & 
           relfreq > 0 &
           Animal_id=="10/10") %>% 
  lm(times_from_birch ~ log(relfreq),data=.) -> lm_10_10

corrrected_data_Sper01 %>% 
  filter(times_from_birch >= start_time & 
         times_from_birch <= end_time & 
           relfreq > 0 &
           Animal_id=="12/10") %>% 
  lm(times_from_birch ~ log(relfreq),data=.) -> lm_12_10

corrrected_data_Sper01 %>% 
  filter(times_from_birch >= start_time & 
         times_from_birch <= end_time & 
           relfreq > 0) %>% 
  lm(times_from_birch ~ log(relfreq) + Animal_id,data=.) -> lm_all

half_life <- tibble(animal_id = c("9/10","10/10","12/10","all"),
                    betula_sper01 = -c(lm_9_10$coefficients[2],
                                      lm_10_10$coefficients[2],
                                      lm_12_10$coefficients[2],
                                      lm_all$coefficients[2]) * log(2) * 24,
                    ci_betula_sper01 = qnorm(p = c(0.975),
                                          mean = 0,
                                          sd = c(summary(lm_9_10)$coefficients[,"Std. Error"][2],
                                             summary(lm_10_10)$coefficients[,"Std. Error"][2],
                                             summary(lm_12_10)$coefficients[,"Std. Error"][2],
                                             summary(lm_all)$coefficients[,"Std. Error"][2])) 
                                           * log(2) * 24,
         ci_betula_sper01_inf = betula_sper01 - ci_betula_sper01,
         ci_betula_sper01_sup = betula_sper01 + ci_betula_sper01)

half_life
```










